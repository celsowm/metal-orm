# Show-SQL Script Usage Guide

The `show-sql.mjs` script displays the SQL generated by MetalORM query builders without executing them.

## Usage Methods

### Method 1: File-based (Original)

Pass a module file that exports a query builder:

```powershell
npm run show-sql -- path/to/query.mjs --dialect=postgres
```

**Example query file:**
```javascript
import { SelectQueryBuilder, defineTable, col } from './dist/index.js';

const users = defineTable('users', { 
  id: col.primaryKey(col.int()), 
  name: col.varchar(255) 
});

export default new SelectQueryBuilder(users)
  .selectRaw('*')
  .limit(10);
```

### Method 2: Heredoc / Stdin (NEW) ✨

Pass query builder code directly via PowerShell heredoc without creating temporary files:

```powershell
@'
import { SelectQueryBuilder, defineTable, col, hasMany, eq } from './dist/index.js';

const Users = defineTable('users', {
  id: col.primaryKey(col.int()),
  name: col.varchar(255),
  email: col.varchar(255)
});

const Orders = defineTable('orders', {
  id: col.primaryKey(col.int()),
  user_id: col.int(),
  total: col.decimal(10, 2),
  status: col.varchar(50)
});

Users.relations = {
  orders: hasMany(Orders, 'user_id')
};

export default new SelectQueryBuilder(Users)
  .selectRaw('*')
  .include('orders', {
    columns: ['id', 'total', 'status']
  })
  .where(eq(Users.columns.id, 1))
  .limit(10);
'@ | npm run show-sql -- -- --stdin --dialect=postgres
```

**Note:** The double `--` is required: the first separates npm arguments from script arguments.

### Method 3: Pipe from File

You can also pipe a file's contents:

```powershell
Get-Content query.mjs | npm run show-sql -- -- --stdin --dialect=mysql
```

## Supported Dialects

- `--dialect=sqlite` (default)
- `--dialect=postgres` or `--dialect=pg`
- `--dialect=mysql`
- `--dialect=mssql` or `--dialect=sqlserver`

## Key Features

✅ **No temporary files needed** - Code is evaluated directly from stdin  
✅ **Relative imports work** - `'./dist/index.js'` is automatically resolved  
✅ **All query features supported** - Relations, joins, CTEs, etc.  
✅ **Multiple dialects** - Test the same query across different databases  

## Common Query Patterns

### HasMany Relationship (1:N)

```javascript
Users.relations = {
  orders: hasMany(Orders, 'user_id')
};

new SelectQueryBuilder(Users)
  .selectRaw('*')
  .include('orders', { columns: ['id', 'total'] })
  .where(eq(Users.columns.id, 1));
```

### BelongsTo Relationship (N:1)

```javascript
Orders.relations = {
  user: belongsTo(Users, 'user_id')
};

new SelectQueryBuilder(Orders)
  .selectRaw('*')
  .include('user', { columns: ['id', 'name'] });
```

### BelongsToMany Relationship (M:N)

```javascript
Users.relations = {
  projects: belongsToMany(Projects, ProjectAssignments, {
    pivotForeignKeyToRoot: 'user_id',
    pivotForeignKeyToTarget: 'project_id'
  })
};

new SelectQueryBuilder(Users)
  .selectRaw('*')
  .include('projects', { 
    columns: ['id', 'name'],
    pivot: { columns: ['assigned_at'] }
  });
```

## Troubleshooting

**Issue:** `ERR_INVALID_URL` or import errors  
**Solution:** Make sure to use relative imports like `'./dist/index.js'` - they are automatically resolved

**Issue:** `Unsupported expression node type`  
**Solution:** Use expression helpers like `eq()`, `like()`, `gt()` in where clauses, not plain objects

**Issue:** npm warns about unknown cli config  
**Solution:** Use the double `--` separator: `npm run show-sql -- -- --stdin`
