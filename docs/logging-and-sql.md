# SQL Logging and Retrieval

MetalORM provides several ways to retrieve the generated SQL for debugging, auditing, or manual execution.

## Manual SQL Retrieval

Any query builder (`SelectQueryBuilder`, `InsertQueryBuilder`, `UpdateQueryBuilder`, `DeleteQueryBuilder`) can be converted to SQL using the `.toSql()` or `.compile()` methods.

### Using `.toSql()`

The `.toSql()` method returns the raw SQL string for a specific dialect.

```typescript
import { selectFromEntity } from 'metal-orm';
import { User } from './entities/User';

const qb = selectFromEntity(User).where(eq(User.columns.id, 1));

// Get SQL for PostgreSQL
const postgresSql = qb.toSql('postgres');
console.log(postgresSql); 
// SELECT "id", "name", "email" FROM "users" WHERE "id" = $1

// Get SQL for MySQL
const mysqlSql = qb.toSql('mysql');
console.log(mysqlSql);
// SELECT `id`, `name`, `email` FROM `users` WHERE `id` = ?
```

### Using `.compile()`

The `.compile()` method returns a `CompiledQuery` object containing both the SQL string and the parameter values.

```typescript
const compiled = qb.compile('postgres');

console.log(compiled.sql);    // SELECT ... WHERE "id" = $1
console.log(compiled.params); // [1]
```

## Runtime Logging

You can log all queries executed during a session by providing a `queryLogger` in the `OrmSession` options.

```typescript
const session = orm.createSession({
  queryLogger: (entry) => {
    console.log(`Executing SQL: ${entry.sql}`);
    console.log(`Parameters: ${JSON.stringify(entry.params)}`);
  }
});

// Any query executed via this session will be logged
const users = await session.findMany(qb);
```

## Advanced Interceptors

For more complex scenarios (e.g., tracing, performance monitoring, or modifying queries globally), you can use `interceptors`.

Interceptors can be registered globally in `OrmOptions` or per session.

```typescript
const orm = new Orm({
  dialect: new PostgresDialect(),
  executorFactory: ...,
  interceptors: new InterceptorPipeline()
});

orm.interceptors.use(async (ctx, next) => {
  const start = Date.now();
  try {
    const results = await next();
    const duration = Date.now() - start;
    console.log(`Query took ${duration}ms: ${ctx.sql}`);
    return results;
  } catch (error) {
    console.error(`Query failed: ${ctx.sql}`, error);
    throw error;
  }
});
```

## CLI Debugging

The `show-sql` tool is useful for quickly inspecting the SQL generated by a query builder without running a full application.

```bash
npm run show-sql -- path/to/query.mjs --dialect=postgres
```

For more details, see the [Show-SQL Script Usage Guide](./show-sql-usage.md).
